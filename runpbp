#!/bin/bash

# Quit immediately if there are any errors
set -e

# Variable assignments (uppercase = exported, lowercase = local)
export PBP_WD="$(pwd)"
export PBP_LIBD="$(python -c "import os, sys; print(os.path.abspath(sys.argv[1]))" "$2")"

# Get full path of first parameter, then extract directory and basename
param1_full="$(python -c "import os, sys; print(os.path.abspath(sys.argv[1]))" "$1")"
export PBP_APPD="$(dirname "${param1_full}")"
app_main_base="$(basename "${param1_full}" .drawio)"
app_main="${PBP_APPD}/${app_main_base}.drawio"

# PBP arg: third parameter as full path if it's a file, otherwise just the parameter
if [[ -f "$3" ]]; then
    export PBP_arg="$(python -c "import os, sys; print(os.path.abspath(sys.argv[1]))" "$3")"
else
    export PBP_arg="$3"
fi

export PBP_t2t="${PBP_LIBD}/t2t.sh"
export PBP_das2json="${PBP_LIBD}/das2json.sh"
export PBP_split_outputs="${PBP_LIBD}/splitoutputs.sh"
export PBP_check_for_errors="${PBP_LIBD}/check-for-errors.sh"

export PBP_DAS2JSONJS="${PBP_LIBD}/das/das2json.mjs"
export PBP_T2TD="${PBP_LIBD}/t2t"
export PBP_T2T_LIBD="${PBP_LIBD}/t2t/lib"
export PBP_SPLITOUTPUTSJS="${PBP_LIBD}/kernel/splitoutput.js"
export PBP_WSUPPORT="${PBP_WD}/support.mjs"

# Push kernel onto PYTHONPATH
export PYTHONPATH="${PBP_LIBD}/kernel:${PYTHONPATH}"


for i in PBP_WD PBP_WSUPPORT PBP_LIBD PBP_APPD app_main PBP_T2TD PBP_arg PBP_t2t PBP_SPLITOUTPUTSJS PBP_split_outputs PBP_DAS2JSONJS PBP_check_for_errors
do
    echo $i "=" ${!i}
done

# Change to the app directory
cd "${PBP_APPD}"

# Remove all 'out.*' files
rm -f out.*

# Run das2json on app main
"${PBP_das2json}" "${app_main}"

# Run check for errors on app main.json
"${PBP_check_for_errors}" "${app_main}.json"

# Run python and pipe to split outputs
set -x
python main.py "${PBP_LIBD}" "${PBP_arg}" main "${app_main}.json" | "${PBP_split_outputs}"

# Check if the run produced "out.✗"
if [[ -f "out.✗" ]]; then
    mv "out.✗" "ERRORS"
    cat "ERRORS"
    exit 1
else
    # Get basename of PBP_arg for output filenames
    arg_basename="$(basename "${PBP_arg}")"
    
    # Move output files to original working directory with renamed filenames
    mv "out.frish" "${PBP_WD}/${arg_basename}.frish"
    mv "out.dt" "${PBP_WD}/${arg_basename}.dt"
    mv "out.js" "${PBP_WD}/${arg_basename}.js"
    mv "out.py" "${PBP_WD}/${arg_basename}.py"
fi
